<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Dashboard - Sale Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 flex">

    <div id="sidebar-container"></div>

    <main class="flex-1 min-h-screen flex flex-col">
        
        <header class="bg-white border-b border-slate-200 sticky top-0 z-40 px-8 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-800">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl border border-slate-200">
                    <input type="date" id="startDate" class="bg-transparent border-none text-sm focus:ring-0 p-2">
                    <span class="text-slate-400">‡∏ñ‡∏∂‡∏á</span>
                    <input type="date" id="endDate" class="bg-transparent border-none text-sm focus:ring-0 p-2">
                    <button id="btnFilter" class="bg-[#5c56f1] text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition">
                        ‡∏ï‡∏Å‡∏•‡∏á
                    </button>
                </div>
            </div>
        </header>

        <div class="p-8 space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-slate-500 text-sm font-bold uppercase tracking-wider">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <h3 id="totalTickets" class="text-3xl font-black text-slate-800 mt-2">0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <p class="text-emerald-500 text-sm font-bold uppercase tracking-wider">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                    <h3 id="closedTickets" class="text-3xl font-black text-slate-800 mt-2">0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm border-l-4 border-l-rose-500">
                    <p class="text-rose-500 text-sm font-bold uppercase tracking-wider">‡πÄ‡∏Å‡∏¥‡∏ô SLA</p>
                    <h3 id="overSlaCount" class="text-3xl font-black text-slate-800 mt-2">0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm border-l-4 border-l-indigo-500">
                    <p class="text-indigo-500 text-sm font-bold uppercase tracking-wider">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (%)</p>
                    <h3 id="successRate" class="text-3xl font-black text-slate-800 mt-2">0%</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                    <h4 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-indigo-500"></i> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (%)
                    </h4>
                    <div class="h-[300px] flex justify-center">
                        <canvas id="topicChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                    <h4 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-amber-500"></i> ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (SLA)
                    </h4>
                    <div class="h-[300px] flex justify-center">
                        <canvas id="slaChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                    <h4 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-users text-blue-500"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡∏°
                    </h4>
                    <div class="h-[400px]">
                        <canvas id="teamChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config (‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const firebaseConfig = {
            apiKey: "AIzaSyAa2uSD_tjNqYE2eXnZcn75h_jAVscDG-c",
            authDomain: "salesupportsystemapp.firebaseapp.com",
            projectId: "salesupportsystemapp",
            storageBucket: "salesupportsystemapp.firebasestorage.app",
            messagingSenderId: "840890441207",
            appId: "1:840890441207:web:f3a5076d46e963a90de2f2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ‡πÇ‡∏´‡∏•‡∏î Sidebar ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        fetch('sidebar.html').then(response => response.text()).then(data => {
            document.getElementById('sidebar-container').innerHTML = data;
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≤‡∏ü
        let charts = {};

        async function updateDashboard() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô 'tickets' (‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô)
            const ticketRef = collection(db, "tickets");
            let q = query(ticketRef);

            // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ timestamp ‡πÉ‡∏ô Firestore 
            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            const querySnapshot = await getDocs(q);
            const data = [];
            querySnapshot.forEach(doc => data.push(doc.data()));

            processData(data);
        }

        function processData(data) {
            const total = data.length;
            document.getElementById('totalTickets').innerText = total;

            // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Topic)
            const topics = {};
            data.forEach(item => {
                topics[item.topic] = (topics[item.topic] || 0) + 1;
            });

            // 2. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏° (Team)
            const teams = {};
            data.forEach(item => {
                teams[item.team] = (teams[item.team] || 0) + 1;
            });

            // 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• SLA (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
            let onTime = 0, overSla = 0;
            data.forEach(item => {
                if(item.sla_status === 'over') overSla++;
                else onTime++;
            });

            renderCharts(topics, teams, { onTime, overSla }, total);
        }

        function renderCharts(topics, teams, sla, total) {
            // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            Object.values(charts).forEach(c => c.destroy());

            // Chart 1: Topics Pie
            charts.topic = new Chart(document.getElementById('topicChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(topics),
                    datasets: [{
                        data: Object.values(topics).map(v => ((v/total)*100).toFixed(1)),
                        backgroundColor: ['#5c56f1', '#818cf8', '#c7d2fe', '#f8fafc', '#312e81']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            // Chart 2: SLA Doughnut
            charts.sla = new Chart(document.getElementById('slaChart'), {
                type: 'doughnut',
                data: {
                    labels: ['‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (In SLA)', '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Over SLA)'],
                    datasets: [{
                        data: [sla.onTime, sla.overSla],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                }
            });

            // Chart 3: Team Bar
            charts.team = new Chart(document.getElementById('teamChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(teams),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô',
                        data: Object.values(teams),
                        backgroundColor: '#5c56f1',
                        borderRadius: 10
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        document.getElementById('btnFilter').onclick = updateDashboard;
        updateDashboard(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    </script>
</body>
</html>
