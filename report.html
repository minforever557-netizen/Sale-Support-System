<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Team Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

</head>

<body class="bg-slate-100">

<!-- BUTTON DEMO -->
<div class="p-10">
    <button onclick="showDetail('Network')"
        class="bg-indigo-600 text-white px-6 py-3 rounded-xl">
        Open Detail
    </button>
</div>


<!-- ================= MODAL ================= -->
<div id="detail-modal"
class="hidden fixed inset-0 bg-black/40
items-center justify-center z-50">

<div class="bg-white w-[95%] max-w-6xl
rounded-2xl shadow-xl">

    <!-- HEADER -->
    <div class="flex justify-between items-center
    border-b p-6">

        <h2 id="modal-head"
        class="text-xl font-bold">
            Detail
        </h2>

        <button onclick="closeModal()"
        class="text-red-500 font-bold">âœ•</button>
    </div>


    <!-- CONTENT (50 / 50 CENTERED) -->
    <div class="p-10
    flex flex-col lg:flex-row
    justify-center items-start gap-14
    max-h-[75vh] overflow-y-auto">

        <!-- LEFT : GRAPH -->
        <div class="w-full lg:w-1/2 flex justify-center">

            <div class="w-full max-w-md">
                <p class="text-xs font-black text-indigo-600
                uppercase tracking-widest mb-5 text-center">
                    Topic Distribution
                </p>

                <div class="bg-slate-50 rounded-2xl p-6">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

        </div>

        <!-- RIGHT : OWNER LIST -->
        <div class="w-full lg:w-1/2">

            <p class="text-xs font-black text-emerald-600
            uppercase tracking-widest mb-5">
                Team Members
            </p>

            <div id="modal-owners"
            class="space-y-4 max-h-[420px]
            overflow-y-auto pr-2">
            </div>

        </div>

    </div>

</div>
</div>


<script>

// ================= SAMPLE DATA =================
const filteredTickets = [
{sender_team:"IT",sender_subteam:"Network",owner:"Somchai",topic:"Firewall"},
{sender_team:"IT",sender_subteam:"Network",owner:"Somchai",topic:"Firewall"},
{sender_team:"IT",sender_subteam:"Network",owner:"Somchai",topic:"Switch"},
{sender_team:"IT",sender_subteam:"Network",owner:"Anan",topic:"Switch"},
{sender_team:"IT",sender_subteam:"Network",owner:"Anan",topic:"Wifi"},
{sender_team:"IT",sender_subteam:"Network",owner:"Nok",topic:"Wifi"},
{sender_team:"IT",sender_subteam:"Network",owner:"Nok",topic:"Wifi"}
];

let selectedMain="IT";
let selectedSub="";
let detailChart=null;


// ================= OPEN DETAIL =================
function showDetail(sub){

    selectedSub=sub;

    document.getElementById("modal-head").innerText =
        `${selectedMain} / ${sub}`;

    const related = filteredTickets.filter(t =>
        t.sender_team===selectedMain &&
        t.sender_subteam===sub
    );

    const total = related.length;

    const ownerMap={};
    const topicMap={};

    related.forEach(t=>{

        if(!ownerMap[t.owner])
            ownerMap[t.owner]={total:0,topics:{}};

        ownerMap[t.owner].total++;

        ownerMap[t.owner].topics[t.topic] =
            (ownerMap[t.owner].topics[t.topic]||0)+1;

        topicMap[t.topic]=(topicMap[t.topic]||0)+1;
    });

    // OWNER LIST
    document.getElementById("modal-owners").innerHTML =
        Object.entries(ownerMap).map(([owner,data])=>{

            const pct=Math.round(data.total/total*100);

            return `
<div onclick="showOwnerDetail('${owner}')"
class="cursor-pointer border rounded-xl p-4 bg-white
hover:bg-indigo-50 transition">

<div class="flex justify-between font-bold">
${owner}
<span class="text-indigo-600">
${data.total} (${pct}%)
</span>
</div>

</div>`;
        }).join("");

    drawChart(topicMap,total);

    openModal();
}


// ================= OWNER CLICK =================
function showOwnerDetail(owner){

    const related = filteredTickets.filter(t =>
        t.sender_team===selectedMain &&
        t.sender_subteam===selectedSub &&
        t.owner===owner
    );

    const topicMap={};

    related.forEach(t=>{
        topicMap[t.topic]=(topicMap[t.topic]||0)+1;
    });

    drawChart(topicMap,related.length);
}


// ================= DRAW CHART =================
function drawChart(topicMap,total){

    const ctx=document.getElementById("detailChart");

    if(detailChart) detailChart.destroy();

    detailChart=new Chart(ctx,{
        type:"doughnut",
        data:{
            labels:Object.keys(topicMap),
            datasets:[{
                data:Object.values(topicMap),
                backgroundColor:[
                    "#3b82f6",
                    "#ef4444",
                    "#f59e0b",
                    "#10b981",
                    "#8b5cf6",
                    "#06b6d4"
                ]
            }]
        },
        options:{
            cutout:"65%",
            plugins:{
                legend:{position:"bottom"},
                datalabels:{
                    color:"#111",
                    font:{weight:"bold"},
                    formatter:(value)=>{
                        const pct=Math.round(value/total*100);
                        return value+" ("+pct+"%)";
                    }
                }
            }
        },
        plugins:[ChartDataLabels]
    });
}


// ================= MODAL =================
function openModal(){
    document.getElementById("detail-modal")
        .classList.replace("hidden","flex");
}

function closeModal(){
    document.getElementById("detail-modal")
        .classList.replace("flex","hidden");
}

</script>

</body>
</html>
