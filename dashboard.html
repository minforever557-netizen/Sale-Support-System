<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Sale Support System</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">

</head>

<body class="flex h-screen overflow-hidden bg-slate-50">

    <!-- SIDEBAR -->
<aside id="sidebar-container"
class="w-64 shrink-0 h-full bg-white border-r border-slate-200">
</aside>



    <!-- RIGHT AREA -->
    <div class="flex-1 flex flex-col min-w-0">

        <!-- TOPBAR -->
        <div id="topbar-container"></div>

        <!-- MAIN CONTENT -->
        <main class="p-6 md:p-10 max-w-7xl mx-auto w-full space-y-8">

    </header>
<!-- ================= MAIN WRAPPER ================= -->
<div class="flex-1 flex flex-col min-h-screen">

    <!-- ================= PAGE HEADER ================= -->
    <header class="flex items-center justify-between px-8 py-6">

        <div>
            <h1 class="text-3xl font-bold text-slate-800">
                Dashboard
            </h1>
            <p class="text-slate-400 text-sm mt-1">
                ภาพรวมเคสที่คุณเปิดใช้งานในระบบ
            </p>
        </div>

        <button class="btn-primary">
            ➕ สร้าง Ticket ใหม่
        </button>

    </header>


    <!-- ================= CONTENT ================= -->
    <main class="px-8 pb-10 fade-in space-y-8">

        <!-- ===== STATUS SUMMARY ===== -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">

            <div class="glass-card p-6">
                <p class="text-slate-400 text-sm">เคสทั้งหมด</p>
                <h2 id="totalCase" class="text-3xl font-bold mt-2">0</h2>
            </div>

            <div class="glass-card p-6">
                <p class="text-slate-400 text-sm">รอดำเนินการ</p>
                <h2 id="pendingCase" class="text-3xl font-bold mt-2">0</h2>
            </div>

            <div class="glass-card p-6">
                <p class="text-slate-400 text-sm">กำลังดำเนินการ</p>
                <h2 id="progressCase" class="text-3xl font-bold mt-2">0</h2>
            </div>

            <div class="glass-card p-6">
                <p class="text-slate-400 text-sm">เสร็จสิ้น</p>
                <h2 id="doneCase" class="text-3xl font-bold mt-2">0</h2>
            </div>

            <div class="glass-card p-6">
                <p class="text-slate-400 text-sm">ปิดงาน</p>
                <h2 id="closeCase" class="text-3xl font-bold mt-2">0</h2>
            </div>

        </div>


        <!-- ===== RECENT TICKETS ===== -->
        <div class="glass-card p-8">

            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">
                    เคสล่าสุดของคุณ
                </h2>

                <span class="status-badge status-badge-green">
                    REALTIME
                </span>
            </div>

            <!-- TABLE -->
            <div class="overflow-x-auto">

                <table class="w-full text-sm">

                    <thead class="text-slate-400 border-b">
                        <tr>
                            <th class="text-left py-3">Ticket ID</th>
                            <th class="text-left">หัวข้อ</th>
                            <th class="text-left">ทีม</th>
                            <th class="text-left">สถานะ</th>
                            <th class="text-left">วันที่</th>
                        </tr>
                    </thead>

                    <tbody id="recentTicketTable">

                        <tr>
                            <td colspan="5" class="text-center py-10 text-slate-400">
                                ยังไม่มีข้อมูล
                            </td>
                        </tr>

                    </tbody>

                </table>

            </div>

        </div>

    </main>

</div>
            <script type="module">

/* ================= FIREBASE IMPORT ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
    getAuth,
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


/* ================= YOUR FIREBASE CONFIG ================= */
/* ใช้ config เดิมของระบบคุณ */
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
};

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


/* ================= DASHBOARD REALTIME ================= */
onAuthStateChanged(auth, (user) => {

    if (!user) {
        window.location.replace("login.html");
        return;
    }

    /* query ticket ของ user คนนี้ */
    const q = query(
        collection(db, "tickets"),
        where("createdBy", "==", user.uid),
        orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {

        let total = 0;
        let pending = 0;
        let progress = 0;
        let done = 0;
        let close = 0;

        const table = document.getElementById("recentTicketTable");
        table.innerHTML = "";

        snapshot.forEach((doc) => {

            const data = doc.data();
            total++;

            /* ===== COUNT STATUS ===== */
            switch (data.status) {
                case "pending": pending++; break;
                case "progress": progress++; break;
                case "done": done++; break;
                case "close": close++; break;
            }

        });

        /* ===== UPDATE KPI ===== */
        document.getElementById("totalCase").innerText = total;
        document.getElementById("pendingCase").innerText = pending;
        document.getElementById("progressCase").innerText = progress;
        document.getElementById("doneCase").innerText = done;
        document.getElementById("closeCase").innerText = close;


        /* ===== SHOW LAST 5 TICKETS ===== */
        let count = 0;

        snapshot.forEach((doc) => {

            if (count >= 5) return;

            const t = doc.data();

            const tr = document.createElement("tr");
            tr.className = "border-b hover:bg-slate-50";

            tr.innerHTML = `
                <td class="py-4 font-semibold">${doc.id}</td>
                <td>${t.title ?? "-"}</td>
                <td>${t.team ?? "-"}</td>
                <td>
                    <span class="status-badge status-badge-green">
                        ${t.status}
                    </span>
                </td>
                <td>${formatDate(t.createdAt)}</td>
            `;

            table.appendChild(tr);
            count++;

        });

        if (total === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-10 text-slate-400">
                        ยังไม่มีข้อมูล
                    </td>
                </tr>`;
        }

    });

});


/* ================= DATE FORMAT ================= */
function formatDate(timestamp) {

    if (!timestamp) return "-";

    const date = timestamp.toDate();
    return date.toLocaleDateString("th-TH", {
        year: "numeric",
        month: "short",
        day: "numeric"
    });
}

</script>

<script src="./js/layout.js"></script>
<script type="module" src="./js/sidebar-role.js"></script>
<script type="module" src="./js/dashboard.js"></script>

</body>
</html>
